$.extend($.fn.datagrid.methods,{enableDnd:function(a,b){return a.each(function(){function g(a,b){var c=$(a).draggable("proxy").find("span.tree-dnd-icon");c.removeClass("tree-dnd-yes tree-dnd-no").addClass(b?"tree-dnd-yes":"tree-dnd-no")}function h(b){return e.finder.getRow(a,$(b))}var d,e,f,a=this,c=$.data(this,"datagrid");c.disabledRows=[],d=$(this),e=c.options,f=void 0!=b?e.finder.getTr(this,b):e.finder.getTr(this,0,"allbody"),f.draggable({disabled:!1,revert:!0,cursor:"pointer",proxy:function(b){var c=$(b).attr("datagrid-row-index"),d=e.finder.getTr(a,c,"body",1),f=e.finder.getTr(a,c,"body",2),g=$('<div style="z-index:9999999999999"></div>').appendTo("body");return f.clone().removeAttr("id").removeClass("droppable").appendTo(g),d.clone().removeAttr("id").removeClass("droppable").find("td").insertBefore(g.find("td:first")),$('<td><span class="tree-dnd-icon tree-dnd-no" style="position:static">&nbsp;</span></td>').insertBefore(g.find("td:first")),g.find("td").css("vertical-align","middle"),g.hide(),g},deltaX:15,deltaY:15,onBeforeDrag:function(b){return"INPUT TEXTAREA".indexOf(document.activeElement.nodeName)>=0?!1:"function"==typeof e.onBeforeDrag&&0==e.onBeforeDrag.call(a,h(this))?!1:$(b.target).parent().hasClass("datagrid-cell-check")?!1:1!=b.which?!1:(e.finder.getTr(a,$(this).attr("datagrid-row-index")).droppable({accept:"no-accept"}),void 0)},onStartDrag:function(){$(this).draggable("proxy").css({left:-1e4,top:-1e4});var b=h(this);"function"==typeof e.onStartDrag&&e.onStartDrag.call(a,b),c.draggingRow=b},onDrag:function(b){var i,c=b.pageX,d=b.pageY,f=b.data.startX,g=b.data.startY,h=Math.sqrt((c-f)*(c-f)+(d-g)*(d-g));h>3&&($(this).draggable("proxy").show(),i=e.finder.getTr(a,parseInt($(this).attr("datagrid-row-index")),"body"),$.extend(b.data,{startX:i.offset().left,startY:i.offset().top,offsetWidth:0,offsetHeight:0})),this.pageY=b.pageY},onStopDrag:function(){var b,f;for(b=0;b<c.disabledRows.length;b++)f=d.datagrid("getRowIndex",c.disabledRows[b]),f>=0&&e.finder.getTr(a,f).droppable("enable");c.disabledRows=[],f=d.datagrid("getRowIndex",c.draggingRow),d.datagrid("enableDnd",f),"function"==typeof e.onStopDrag&&e.onStopDrag.call(a,c.draggingRow)}}).droppable({accept:"tr.datagrid-row",onDragEnter:function(b,d){if("function"==typeof e.onDragEnter&&0==e.onDragEnter.call(a,h(this),h(d))){g(d,!1);var f=e.finder.getTr(a,$(this).attr("datagrid-row-index"));f.find("td").css("border",""),f.droppable("disable"),c.disabledRows.push(h(this))}},onDragOver:function(b,d){var i,j,k,l,f=h(this);$.inArray(f,c.disabledRows)>=0||(i=d.pageY,j=$(this).offset().top,k=j+$(this).outerHeight(),g(d,!0),l=e.finder.getTr(a,$(this).attr("datagrid-row-index")),l.children("td").css("border",""),i>j+(k-j)/2?l.children("td").css("border-bottom","1px solid red"):l.children("td").css("border-top","1px solid red"),"function"==typeof e.onDragOver&&0==e.onDragOver.call(a,f,h(d))&&(g(d,!1),l.find("td").css("border",""),l.droppable("disable"),c.disabledRows.push(f)))},onDragLeave:function(b,c){g(c,!1);var d=e.finder.getTr(a,$(this).attr("datagrid-row-index"));d.children("td").css("border",""),"function"==typeof e.onDragLeave&&e.onDragLeave.call(a,h(this),h(c))},onDrop:function(b,c){function n(){var b=$(a).datagrid("getRows")[f],c=0;c="top"==j?g:g+1,f>c?(d.datagrid("deleteRow",f).datagrid("insertRow",{index:c,row:b}),d.datagrid("enableDnd",c)):(d.datagrid("insertRow",{index:c,row:b}).datagrid("deleteRow",f),d.datagrid("enableDnd",c-1))}var k,l,m,f=parseInt($(c).attr("datagrid-row-index")),g=parseInt($(this).attr("datagrid-row-index")),h=e.finder.getTr(a,$(this).attr("datagrid-row-index")),i=h.children("td"),j=parseInt(i.css("border-top-width"))?"top":"bottom";i.css("border",""),k=d.datagrid("getRows"),l=k[g],m=k[f],("function"!=typeof e.onBeforeDrop||0!=e.onBeforeDrop.call(a,l,m,j))&&(n(),"function"==typeof e.onDrop&&e.onDrop.call(a,l,m,j))}})})}});